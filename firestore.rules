rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Sessions collection
    match /sessions/{sessionId} {
      // Read: Authenticated users can read sessions
      allow read: if isAuthenticated();
      
      // Create: User can create sessions
      allow create: if isAuthenticated() && 
                      (!('userId' in request.resource.data) || 
                       request.resource.data.userId == request.auth.uid);
      
      // Update: Authenticated users can update (backend validates ownership)
      allow update: if isAuthenticated();
      
      // Delete: Authenticated users can delete (backend validates ownership)
      allow delete: if isAuthenticated();
      
      // Messages subcollection - SIMPLIFIED RULES
      match /messages/{messageId} {
        // Create: Must be authenticated with valid message structure
        // Ownership validation happens in backend code
        allow create: if isAuthenticated() &&
                        request.resource.data.timestamp != null &&
                        request.resource.data.role in ['user', 'assistant'] &&
                        request.resource.data.content is string;
        
        // Read: Authenticated users can read
        allow read: if isAuthenticated();
        
        // Update/Delete: Allow for corrections
        allow update, delete: if isAuthenticated();
      }
      
      // Edit messages subcollection
      match /editMessages/{editMessageId} {
        allow create: if isAuthenticated() &&
                        request.resource.data.timestamp != null &&
                        request.resource.data.role in ['user', 'assistant'] &&
                        request.resource.data.content is string;
        allow read: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }
    }
  }
}
